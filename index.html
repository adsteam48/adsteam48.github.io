<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discord„Çπ„ÉÜ„Éº„Çø„Çπ</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.container {
    width: 100%;
    max-width: 500px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    color: white;
}

.header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 8px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.sparkle {
    display: inline-block;
    animation: sparkle 2s ease-in-out infinite;
}

@keyframes sparkle {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.2) rotate(180deg); }
}

.subtitle {
    font-size: 0.95rem;
    opacity: 0.9;
}

.status-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.banner {
    height: 100px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card-content {
    padding: 0 30px 30px 30px;
}

.avatar-wrapper {
    display: flex;
    justify-content: center;
    margin-top: -50px;
    margin-bottom: 20px;
}

.avatar {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #e0e0e0;
    border: 5px solid white;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    overflow: hidden;
}

.avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-status-badge {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    background: #747f8d;
}

.avatar-status-badge.online {
    background: #43b581;
}

.avatar-status-badge.idle {
    background: #faa61a;
}

.avatar-status-badge.dnd {
    background: #f04747;
}

.avatar-status-badge.offline {
    background: #747f8d;
}

.user-info {
    text-align: center;
    margin-bottom: 25px;
}

.username {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c2f33;
    margin-bottom: 5px;
}

.user-tag {
    color: #99aab5;
    font-size: 0.95rem;
}

.section {
    margin-bottom: 25px;
}

.section-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #99aab5;
    margin-bottom: 12px;
    letter-spacing: 0.5px;
}

.bio {
    background: #f6f7f8;
    padding: 15px;
    border-radius: 8px;
    color: #2c2f33;
    line-height: 1.6;
}

.activity-card {
    background: #f6f7f8;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.2s ease;
}

.activity-card:hover {
    background: #ebedef;
    transform: translateX(3px);
}

.activity-card:last-child {
    margin-bottom: 0;
}

.activity-card.playing {
    background: linear-gradient(135deg, #f6f7f8 0%, #e8f5e9 100%);
    border-left: 3px solid #43b581;
}

.activity-card.spotify-card {
    background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
    color: white;
    flex-direction: column;
    align-items: stretch;
}

.connection-card {
    background: #f6f7f8;
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s ease;
}

.connection-card:hover {
    background: #ebedef;
    transform: translateX(3px);
}

.connection-card:last-child {
    margin-bottom: 0;
}

.connection-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1.3rem;
    flex-shrink: 0;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.connection-info {
    flex: 1;
    min-width: 0;
}

.connection-name {
    font-weight: 700;
    color: #2c2f33;
    font-size: 0.95rem;
    margin-bottom: 2px;
}

.connection-username {
    font-size: 0.85rem;
    color: #99aab5;
}

.connection-verified {
    color: #43b581;
    font-size: 1rem;
    flex-shrink: 0;
}

.activity-icon-wrapper {
    flex-shrink: 0;
}

.activity-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0,0,0,0.1);
    font-size: 2rem;
}

.activity-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-name {
    font-weight: 700;
    color: #2c2f33;
    margin-bottom: 4px;
}

.activity-details {
    font-size: 0.9rem;
    color: #99aab5;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.activity-time {
    text-align: right;
    flex-shrink: 0;
    font-weight: 700;
    color: #667eea;
    font-size: 1.1rem;
}

.spotify-card .activity-icon-wrapper {
    width: 100%;
}

.spotify-card .activity-icon {
    width: 100%;
    height: 80px;
}

.spotify-content {
    width: 100%;
}

.spotify-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    opacity: 0.9;
}

.spotify-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 4px;
}

.spotify-subtitle {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 10px;
}

.spotify-progress {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    font-size: 0.75rem;
}

.spotify-bar {
    flex: 1;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
    overflow: hidden;
}

.spotify-bar-fill {
    height: 100%;
    background: white;
    border-radius: 2px;
    transition: width 0.3s ease;
}

.spotify-actions {
    display: flex;
    gap: 10px;
}

.spotify-action {
    flex: 1;
    padding: 8px 12px;
    background: rgba(255,255,255,0.2);
    border-radius: 6px;
    text-align: center;
    color: white;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    transition: background 0.2s ease;
}

.spotify-action:hover {
    background: rgba(255,255,255,0.3);
}

.footer {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #ebedef;
    text-align: center;
}

.last-update {
    color: #99aab5;
    font-size: 0.85rem;
}

@media (max-width: 600px) {
    .header h1 {
        font-size: 1.5rem;
    }
    
    .card-content {
        padding: 0 20px 20px 20px;
    }
    
    .activity-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .activity-time {
        width: 100%;
        text-align: left;
    }
}
</style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><span class="sparkle">‚ú®</span><span id="header-username">yiyf667</span>„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ<span class="sparkle">‚ú®</span></h1>
        <p class="subtitle">„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞‰∏≠</p>
    </div>

    <div class="status-card">
        <div class="banner"></div>

        <div class="card-content">
            <div class="avatar-wrapper">
                <div class="avatar">
                    <img id="avatar" style="display:none;" alt="„Ç¢„Éê„Çø„Éº">
                    <div class="avatar-status-badge" id="avatar-status-badge"></div>
                </div>
            </div>

            <div class="user-info">
                <div class="username" id="username">yiyf667</div>
                <div class="user-tag" id="user-tag">@yiyf667</div>
            </div>

            <div id="about-section" class="section" style="display:none;">
                <div class="section-title">Ëá™Â∑±Á¥π‰ªã</div>
                <div class="bio" id="about-text"></div>
            </div>

            <div id="activity-section" class="section" style="display:none;">
                <div class="section-title">„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£</div>
                <div id="activities-container"></div>
            </div>

            <div id="connections-section" class="section" style="display:none;">
                <div class="section-title">ÈÄ£Êê∫„Ç¢„Ç´„Ç¶„É≥„Éà</div>
                <div id="connections-container"></div>
            </div>

            <div id="custom-status-section" style="display:none;"></div>

            <div class="footer">
                <div class="last-update">
                    üïê <span id="last-update">--:--:--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = 'https://api.lanyard.rest/v1/users';
const DISCORD_USER_ID = '1403167996607725629';
const REFRESH_INTERVAL = 5000;

function getRequestedUsernameFromPath() {
    try {
        const parts = location.pathname.split('/').filter(Boolean);
        if (parts.length >= 2 && parts[0].toLowerCase() === 'card') {
            return decodeURIComponent(parts[1]);
        }
    } catch (e) {
        console.warn('Could not parse username from path', e);
    }
    return null;
}

function formatElapsedTime(seconds) {
    if (!seconds || seconds < 0) return '0:00';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    return `${minutes}:${String(secs).padStart(2, '0')}`;
}

function clamp01(n) {
    if (typeof n !== 'number' || !isFinite(n)) return 0;
    return Math.max(0, Math.min(1, n));
}

async function fetchStatus() {
    try {
        const url = `${API_URL}/${DISCORD_USER_ID}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error('API error');
        const result = await response.json();
        
        // Lanyard API„ÅÆ„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„Å´ÂØæÂøú
        const data = {
            username: result.data.discord_user.username,
            avatar_url: `https://cdn.discordapp.com/avatars/${result.data.discord_user.id}/${result.data.discord_user.avatar}.png?size=256`,
            status: result.data.discord_status,
            about: result.data.kv?.about || null,
            connections: result.data.kv?.connections ? JSON.parse(result.data.kv.connections) : null,
            activities: (result.data.activities || []).map(act => ({
                name: act.name,
                state: act.state,
                details: act.details,
                start_timestamp: act.timestamps?.start ? act.timestamps.start / 1000 : null,
                end_timestamp: act.timestamps?.end ? act.timestamps.end / 1000 : null,
                image_url: act.assets?.large_image ? 
                    (act.assets.large_image.startsWith('mp:') 
                        ? `https://media.discordapp.net/${act.assets.large_image.slice(3)}`
                        : `https://cdn.discordapp.com/app-assets/${act.application_id}/${act.assets.large_image}.png`)
                    : null,
                source: act.name === 'Spotify' ? 'Spotify' : null,
                url: act.name === 'Spotify' ? `https://open.spotify.com/track/${act.sync_id}` : null,
                type: act.type
            }))
        };
        
        updateUI(data);
        updateLastUpdate();
    } catch (error) {
        console.error('Error fetching status:', error);
        document.getElementById('username').textContent = 'Êé•Á∂ö„Ç®„É©„Éº';
    }
}

function updateUI(data) {
    if (data.username) {
        document.getElementById('username').textContent = data.username;
        document.getElementById('header-username').textContent = data.username;
        document.getElementById('user-tag').textContent = `@${data.username}`;
    }

    if (data.avatar_url) {
        const avatar = document.getElementById('avatar');
        avatar.src = data.avatar_url;
        avatar.style.display = 'block';
    }

    const avatarStatusBadge = document.getElementById('avatar-status-badge');
    if (avatarStatusBadge && data.status) {
        avatarStatusBadge.className = `avatar-status-badge ${data.status}`;
    }

    const aboutSection = document.getElementById('about-section');
    if (data.about) {
        aboutSection.style.display = 'block';
        document.getElementById('about-text').textContent = data.about;
    } else {
        aboutSection.style.display = 'none';
    }

    const activitySection = document.getElementById('activity-section');
    const activitiesContainer = document.getElementById('activities-container');
    
    if (data.activities && data.activities.length > 0) {
        activitySection.style.display = 'block';
        activitiesContainer.innerHTML = '';
        
        data.activities.forEach(activity => {
            const activityCard = document.createElement('div');
            const isSpotify = activity && activity.source === 'Spotify';
            const now = new Date();

            if (isSpotify) {
                const startTime = activity.start_timestamp ? new Date(activity.start_timestamp * 1000) : null;
                const endTime = activity.end_timestamp ? new Date(activity.end_timestamp * 1000) : null;
                const elapsedSeconds = startTime ? (now - startTime) / 1000 : 0;
                const durationSeconds = (startTime && endTime) ? Math.max(0, (endTime - startTime) / 1000) : 0;
                const progress = durationSeconds > 0 ? clamp01(elapsedSeconds / durationSeconds) : 0;

                const title = activity.name || 'Spotify';
                const artist = activity.state || '';
                const album = activity.details || '';
                const trackUrl = activity.url || 'https://open.spotify.com';

                activityCard.className = 'activity-card spotify-card';
                activityCard.innerHTML = `
                    <div class="activity-icon-wrapper">
                        <div class="activity-icon">
                            ${activity.image_url ? `<img src="${activity.image_url}" alt="${title}">` : 'üéµ'}
                        </div>
                    </div>
                    <div class="spotify-content">
                        <div class="spotify-label">Spotify„ÇíÂÜçÁîü‰∏≠</div>
                        <div class="spotify-title">${title}</div>
                        <div class="spotify-subtitle">${[artist, album].filter(Boolean).join(' ‚Ä¢ ')}</div>
                        <div class="spotify-progress">
                            <div class="spotify-time">${formatElapsedTime(elapsedSeconds)}</div>
                            <div class="spotify-bar" role="progressbar" aria-valuenow="${Math.round(progress * 100)}" aria-valuemin="0" aria-valuemax="100">
                                <div class="spotify-bar-fill" style="width: ${Math.round(progress * 100)}%"></div>
                            </div>
                            <div class="spotify-time">${durationSeconds > 0 ? formatElapsedTime(durationSeconds) : '--:--'}</div>
                        </div>
                        <div class="spotify-actions">
                            <a class="spotify-action" href="${trackUrl}" target="_blank" rel="noopener noreferrer">‰∏ÄÁ∑í„Å´ËÅ¥„Åè</a>
                            <a class="spotify-action" href="https://open.spotify.com" target="_blank" rel="noopener noreferrer">Spotify„Å´Êé•Á∂ö</a>
                        </div>
                    </div>
                `;
                activitiesContainer.appendChild(activityCard);
                return;
            }

            let isPlaying = false;
            if (activity.type) {
                try {
                    const typeStr = String(activity.type).toLowerCase();
                    if (typeStr.includes('play')) isPlaying = true;
                } catch (e) {}
            }
            if (!activity.state && !activity.details) {
                isPlaying = true;
            }

            activityCard.className = 'activity-card' + (isPlaying ? ' playing' : '');

            const details = [];
            if (activity.state) details.push(activity.state);
            if (activity.details) details.push(activity.details);

            const elapsed = activity.start_timestamp
                ? formatElapsedTime((now - new Date(activity.start_timestamp * 1000)) / 1000)
                : '0:00';

            activityCard.innerHTML = `
                <div class="activity-icon-wrapper">
                    <div class="activity-icon">
                        ${activity.image_url ? `<img src="${activity.image_url}" alt="${activity.name}">` : 'üéÆ'}
                    </div>
                </div>
                <div class="activity-content">
                    <div class="activity-name">${activity.name}</div>
                    <div class="activity-details">${details.length > 0 ? details.join(' ‚Ä¢ ') : '‚ñ∂Ô∏è „Éó„É¨„Ç§‰∏≠'}</div>
                </div>
                <div class="activity-time">${elapsed}</div>
            `;
            activitiesContainer.appendChild(activityCard);
        });
    } else {
        activitySection.style.display = 'none';
    }

    // ÈÄ£Êê∫„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆË°®Á§∫
    const connectionsSection = document.getElementById('connections-section');
    const connectionsContainer = document.getElementById('connections-container');
    
    if (data.connections && data.connections.length > 0) {
        connectionsSection.style.display = 'block';
        connectionsContainer.innerHTML = '';
        
        const connectionIcons = {
            'spotify': 'üéµ',
            'youtube': '‚ñ∂Ô∏è',
            'twitch': 'üíú',
            'twitter': 'üê¶',
            'github': 'üêô',
            'steam': 'üéÆ',
            'reddit': 'ü§ñ',
            'xbox': 'üéÆ',
            'playstation': 'üéÆ',
            'battlenet': '‚öîÔ∏è',
            'epicgames': 'üéÆ',
            'leagueoflegends': 'üéÆ',
            'facebook': 'üë§',
            'instagram': 'üì∑',
            'tiktok': 'üéµ'
        };
        
        data.connections.forEach(connection => {
            const connCard = document.createElement('div');
            connCard.className = 'connection-card';
            
            const icon = connectionIcons[connection.type.toLowerCase()] || 'üîó';
            const typeName = connection.type.charAt(0).toUpperCase() + connection.type.slice(1);
            
            connCard.innerHTML = `
                <div class="connection-icon">${icon}</div>
                <div class="connection-info">
                    <div class="connection-name">${typeName}</div>
                    <div class="connection-username">${connection.name}</div>
                </div>
                ${connection.verified ? '<div class="connection-verified">‚úì</div>' : ''}
            `;
            
            connectionsContainer.appendChild(connCard);
        });
    } else {
        connectionsSection.style.display = 'none';
    }
}

function updateLastUpdate() {
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString('ja-JP');
}

function addCardTilt() {
    const card = document.querySelector('.status-card');
    if (!card) return;

    const maxDeg = 12;
    const scaleOnHover = 1.02;

    function handleMove(e) {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const halfW = rect.width / 2;
        const halfH = rect.height / 2;
        const rotateY = ((x - halfW) / halfW) * maxDeg;
        const rotateX = -((y - halfH) / halfH) * maxDeg;
        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(${scaleOnHover})`;
        card.style.boxShadow = '0 20px 40px rgba(0,0,0,0.12)';
    }

    function handleLeave() {
        card.style.transform = '';
        card.style.boxShadow = '';
    }

    card.addEventListener('mousemove', handleMove);
    card.addEventListener('touchmove', function(e){
        if (e.touches && e.touches[0]) handleMove(e.touches[0]);
    }, {passive: true});
    card.addEventListener('mouseleave', handleLeave);
    card.addEventListener('touchend', handleLeave);
}

function init() {
    console.log('Status display initialized');
    const requested = getRequestedUsernameFromPath();
    if (requested) {
        document.getElementById('username').textContent = requested;
        document.getElementById('header-username').textContent = requested;
        document.getElementById('user-tag').textContent = `@${requested}`;
    } else {
        // „Éá„Éï„Ç©„É´„Éà„É¶„Éº„Ç∂„ÉºÂêç
        document.getElementById('username').textContent = 'yiyf667';
        document.getElementById('header-username').textContent = 'yiyf667';
        document.getElementById('user-tag').textContent = '@yiyf667';
    }
    fetchStatus();
    try {
        addCardTilt();
    } catch (e) {
        console.warn('addCardTilt failed', e);
    }
    setInterval(fetchStatus, REFRESH_INTERVAL);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>

</body>
</html>
