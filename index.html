<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ファイルサーバー 全対応版</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; color:#333; padding:20px; }
.header { text-align:center; margin-bottom:20px; color:white; }
.files-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:20px; }
.file-card { background:rgba(255,255,255,0.95); border-radius:12px; padding:15px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.15); }
.file-icon { font-size:3rem; margin-bottom:10px; }
.file-name { font-weight:bold; margin-bottom:8px; word-break:break-word; }
.file-actions button { margin:3px; padding:5px 10px; border-radius:5px; cursor:pointer; }
.upload-area { margin-bottom:20px; }
.dragover { border:2px dashed #764ba2; background: rgba(102,126,234,0.1); }
.progress-bar { width:100%; height:4px; background:#f0f0f0; border-radius:2px; margin:10px 0; overflow:hidden; display:none; }
.progress-fill { height:100%; background: linear-gradient(90deg,#667eea,#764ba2); width:0%; transition: width 0.3s ease; }
</style>
</head>
<body>

<div class="header">
    <h1>📁 ファイルサーバー 全対応版</h1>
</div>

<div class="upload-area">
    <button id="createFolderBtn">📂 フォルダ作成</button>
    <button id="backBtn" style="display:none;">⬅ 戻る</button>
    <div id="uploadZone" style="border:2px dashed #667eea; border-radius:10px; padding:20px; margin-top:10px; text-align:center; cursor:pointer;">
        ドラッグ&ドロップまたはクリックでアップロード
        <input type="file" id="fileInput" multiple style="display:none;">
    </div>
    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<div class="files-grid" id="filesGrid"></div>

<!-- 一時リンクモーダル -->
<div id="tempLinkModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;">
    <div style="background:white;border-radius:12px;padding:20px;max-width:500px;width:90%;text-align:center;">
        <h3>🔗 一時的なダウンロードリンク</h3>
        <div id="tempLinkText" style="background: rgba(102, 126, 234, 0.1); border:1px solid #667eea; border-radius:5px; padding:10px; word-break:break-all; margin:10px 0;"></div>
        <button id="copyLinkBtn">コピー</button>
        <button id="closeLinkModal">閉じる</button>
    </div>
</div>

<script>
class FileServer {
    constructor() {
        this.files = this.load('files');
        this.folders = this.load('folders');
        this.currentFolderId = null;
        this.folderStack = [];
        this.tempLinks = new Map();
        this.init();
    }

    init(){
        this.setupEventListeners();
        this.render();
        this.checkTempLink();
    }

    setupEventListeners(){
        const uploadZone=document.getElementById('uploadZone');
        const fileInput=document.getElementById('fileInput');
        const createFolderBtn=document.getElementById('createFolderBtn');
        const backBtn=document.getElementById('backBtn');
        const closeLinkModal=document.getElementById('closeLinkModal');
        const copyLinkBtn=document.getElementById('copyLinkBtn');

        uploadZone.addEventListener('click',()=>fileInput.click());
        uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover');});
        uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.classList.remove('dragover'); this.handleFiles(e.dataTransfer.files);});

        fileInput.addEventListener('change',e=>this.handleFiles(e.target.files));

        createFolderBtn.addEventListener('click',()=>{
            const name=prompt('フォルダ名を入力'); if(name)this.createFolder(name);
        });

        backBtn.addEventListener('click',()=>this.goBack());

        closeLinkModal.addEventListener('click',()=>document.getElementById('tempLinkModal').style.display='none');
        copyLinkBtn.addEventListener('click',()=>{navigator.clipboard.writeText(document.getElementById('tempLinkText').textContent); alert('コピーしました');});
    }

    handleFiles(files){
        const progressBar=document.getElementById('progressBar');
        const progressFill=document.getElementById('progressFill');
        progressBar.style.display='block';
        const arr=Array.from(files);
        arr.forEach((file,i)=>{
            const reader=new FileReader();
            reader.onload=()=>{
                this.files.push({
                    id:this.generateId(),
                    name:file.name,
                    type:file.type,
                    size:file.size,
                    data:reader.result,
                    parent:this.currentFolderId
                });
                this.save('files',this.files);
                progressFill.style.width=((i+1)/arr.length*100)+'%';
                if(i===arr.length-1) setTimeout(()=>progressBar.style.display='none',300);
                this.render();
            };
            reader.readAsDataURL(file);
        });
    }

    createFolder(name){
        const folder={id:this.generateId(), name, type:'folder', parent:this.currentFolderId};
        this.folders.push(folder);
        this.save('folders',this.folders);
        this.render();
    }

    openFolder(id){
        this.folderStack.push(this.currentFolderId);
        this.currentFolderId=id;
        document.getElementById('backBtn').style.display='inline-block';
        this.render();
    }

    goBack(){
        this.currentFolderId=this.folderStack.pop()||null;
        if(!this.folderStack.length) document.getElementById('backBtn').style.display='none';
        this.render();
    }

    render(){
        const grid=document.getElementById('filesGrid'); grid.innerHTML='';
        const folders=this.folders.filter(f=>f.parent===this.currentFolderId);
        const files=this.files.filter(f=>f.parent===this.currentFolderId);

        folders.forEach(f=>{
            const card=document.createElement('div'); card.className='file-card';
            card.innerHTML=`<div class="file-icon">📁</div><div class="file-name">${f.name}</div><button onclick="fileServer.openFolder('${f.id}')">開く</button>`;
            grid.appendChild(card);
        });

        files.forEach(f=>{
            const card=document.createElement('div'); card.className='file-card';
            let media='';
            if(f.type.startsWith('image/')) media=`<img src="${f.data}" style="max-width:100%;border-radius:5px;">`;
            else if(f.type.startsWith('video/')) media=`<video controls style="max-width:100%;border-radius:5px;"><source src="${f.data}" type="${f.type}"></video>`;
            else if(f.type.startsWith('audio/')) media=`<audio controls style="width:100%;"><source src="${f.data}" type="${f.type}"></audio>`;
            card.innerHTML=`<div class="file-icon">📄</div><div class="file-name">${f.name}</div>${media}<div><button onclick="fileServer.downloadFile('${f.id}')">💾 ダウンロード</button><button onclick="fileServer.deleteFile('${f.id}')">🗑️ 削除</button><button onclick="fileServer.createTempLink('${f.id}')">🔗 一時リンク</button></div>`;
            grid.appendChild(card);
        });
    }

    downloadFile(id){
        const f=this.files.find(x=>x.id===id); if(!f)return;
        const a=document.createElement('a'); a.href=f.data; a.download=f.name; a.click();
    }

    deleteFile(id){
        if(confirm('削除しますか？')){
            this.files=this.files.filter(f=>f.id!==id);
            this.save('files',this.files);
            this.render();
        }
    }

    createTempLink(id){
        const linkId=this.generateId();
        const expiry=Date.now()+(24*60*60*1000);
        this.tempLinks.set(linkId,{fileId:id,expiry});
        document.getElementById('tempLinkText').textContent=`${window.location.href}#temp/${linkId}`;
        document.getElementById('tempLinkModal').style.display='flex';
    }

    checkTempLink(){
        const hash=window.location.hash;
        if(hash.startsWith('#temp/')){
            const id=hash.slice(6);
            const data=this.tempLinks.get(id);
            if(data && Date.now()<data.expiry){
                this.downloadFile(data.fileId);
            } else {
                alert('リンクが無効または期限切れです');
            }
        }
    }

    save(key,val){ localStorage.setItem(key,JSON.stringify(val)); }
    load(key){ const d=localStorage.getItem(key); return d?JSON.parse(d):[]; }
    generateId(){ return Date.now().toString(36)+Math.random().toString(36).substr(2); }
}

const fileServer=new FileServer();
</script>

</body>
</html>
