<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ©ãƒãƒ­ãƒƒãƒˆè‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 1000px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
        .section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        button.success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
            font-size: 0.9em;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status.active {
            background: #fff3cd;
            color: #856404;
        }
        #gamepadInfo {
            margin-top: 15px;
        }
        .gamepad-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .gamepad-button {
            padding: 12px 8px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85em;
            transition: all 0.2s;
            font-weight: 600;
        }
        .gamepad-button:hover {
            background: #dee2e6;
        }
        .gamepad-button.pressed {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(0.95);
        }
        .gamepad-button.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }
        #videoContainer {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }
        #capturedVideo {
            width: 100%;
            height: auto;
            display: block;
        }
        #analysisCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .detection-zone {
            background: white;
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            border: 2px solid #17a2b8;
        }
        .zone-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .zone-controls input, .zone-controls select {
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .color-preview {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            vertical-align: middle;
            margin-left: 10px;
        }
        #logArea {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.info { color: #0ff; }
        .log-entry.success { color: #0f0; }
        .log-entry.warning { color: #ff0; }
        .log-entry.error { color: #f00; }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .info-box {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .info-box strong {
            color: #1976D2;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #dee2e6;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        .detection-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: red;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 10;
        }
        .detection-marker.detected {
            background: lime;
            box-shadow: 0 0 10px lime;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ãƒ©ãƒãƒ­ãƒƒãƒˆè‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«</h1>
        <p class="subtitle">ç¸¦æ£’ã®å‹•ãã‚’æ¤œå‡ºã—ã¦æ°´è‰²ã‚¨ãƒªã‚¢ã§è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯</p>

        <div class="two-column">
            <!-- å·¦ã‚«ãƒ©ãƒ : è¨­å®šã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
            <div>
                <!-- æ¤œå‡ºè¨­å®š -->
                <div class="section">
                    <h2>ğŸ¨ æ°´è‰²æ¤œå‡ºè¨­å®š</h2>
                    <div class="detection-zone">
                        <label style="display: block; margin-bottom: 10px;">
                            <strong>æ¤œå‡ºä½ç½®ï¼ˆXåº§æ¨™ %ï¼‰:</strong>
                            <input type="number" id="detectX" value="50" min="0" max="100" 
                                   style="width: 80px; margin-left: 10px;">
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <strong>æ¤œå‡ºç¯„å›²ï¼ˆYåº§æ¨™ %ï¼‰:</strong>
                            é–‹å§‹: <input type="number" id="detectYStart" value="30" min="0" max="100" style="width: 60px;">
                            çµ‚äº†: <input type="number" id="detectYEnd" value="70" min="0" max="100" style="width: 60px;">
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <strong>æ¤œå‡ºè‰²ï¼ˆæ°´è‰²ï¼‰:</strong>
                            <input type="color" id="targetColor" value="#00bfff">
                            <span class="color-preview" id="colorPreview" style="background: #00bfff;"></span>
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <strong>è‰²ã®è¨±å®¹èª¤å·®:</strong>
                            <input type="range" id="colorThreshold" min="10" max="100" value="40" 
                                   style="width: 150px; margin-left: 10px;">
                            <span id="thresholdValue">40</span>
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <strong>ã‚¹ã‚­ãƒ£ãƒ³ç²¾åº¦:</strong>
                            <select id="scanDensity">
                                <option value="1">è¶…é«˜ç²¾åº¦ï¼ˆé‡ã„ï¼‰</option>
                                <option value="3" selected>é«˜ç²¾åº¦</option>
                                <option value="5">æ¨™æº–</option>
                                <option value="10">ä½ç²¾åº¦ï¼ˆè»½ã„ï¼‰</option>
                            </select>
                        </label>
                        <label style="display: block; margin-bottom: 10px;">
                            <strong>åå¿œæ„Ÿåº¦:</strong>
                            <select id="reactionSpeed">
                                <option value="100">è¶…é«˜é€Ÿï¼ˆ100mså¾…æ©Ÿï¼‰</option>
                                <option value="200">é«˜é€Ÿï¼ˆ200mså¾…æ©Ÿï¼‰</option>
                                <option value="300" selected>æ¨™æº–ï¼ˆ300mså¾…æ©Ÿï¼‰</option>
                                <option value="500">ä½é€Ÿï¼ˆ500mså¾…æ©Ÿï¼‰</option>
                            </select>
                        </label>
                    </div>
                    <div class="info-box">
                        <strong>ğŸ’¡ è¨­å®šã®ãƒ’ãƒ³ãƒˆ:</strong><br>
                        â€¢ Xåº§æ¨™: ç¸¦æ£’ãŒé€šéã™ã‚‹æ¨ªä½ç½®<br>
                        â€¢ Yç¯„å›²: æ°´è‰²ã‚¨ãƒªã‚¢ã®ç¸¦ã®ç¯„å›²<br>
                        â€¢ è‰²ã®èª¤å·®: å¤§ãã„ã»ã©æ¤œå‡ºã—ã‚„ã™ã„
                    </div>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
                <div class="section" style="margin-top: 20px;">
                    <h2>ğŸ“± ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h2>
                    <p style="font-size: 0.9em; color: #666;">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è‡ªå‹•æ¤œå‡ºON/OFF</p>
                    <span class="status disconnected" id="gamepadStatus">æœªæ¥ç¶š</span>
                    <div id="gamepadInfo"></div>
                </div>

                <!-- çµ±è¨ˆ -->
                <div class="section" style="margin-top: 20px;">
                    <h2>ğŸ“Š å®Ÿè¡Œçµ±è¨ˆ</h2>
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="statClicks">0</div>
                            <div class="stat-label">æ¤œå‡ºæˆåŠŸ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statMiss">0</div>
                            <div class="stat-label">æ¤œå‡ºå¤±æ•—</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statRate">0%</div>
                            <div class="stat-label">æˆåŠŸç‡</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ : ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ -->
            <div>
                <!-- ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ -->
                <div class="section">
                    <h2>ğŸ–¥ï¸ ã‚²ãƒ¼ãƒ ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£</h2>
                    <div class="action-buttons">
                        <button onclick="startCapture()" id="captureBtn">ğŸ“¸ ç”»é¢å…±æœ‰é–‹å§‹</button>
                        <button onclick="stopCapture()" id="stopCaptureBtn" class="danger" disabled>â¹ï¸ åœæ­¢</button>
                        <button onclick="pickColor()" id="pickColorBtn" disabled>ğŸ¨ ç”»é¢ã‹ã‚‰è‰²æŠ½å‡º</button>
                    </div>
                    <span class="status disconnected" id="captureStatus">æœªå…±æœ‰</span>
                    <div id="videoContainer">
                        <video id="capturedVideo" autoplay playsinline></video>
                        <canvas id="analysisCanvas"></canvas>
                    </div>
                </div>

                <!-- è‡ªå‹•æ“ä½œåˆ¶å¾¡ -->
                <div class="section" style="margin-top: 20px;">
                    <h2>âš¡ è‡ªå‹•æ¤œå‡ºåˆ¶å¾¡</h2>
                    <div class="action-buttons">
                        <button onclick="toggleAutomation()" id="automationBtn" class="success">ğŸš€ è‡ªå‹•æ¤œå‡º: OFF</button>
                        <button onclick="testDetection()" id="testBtn">ğŸ§ª æ¤œå‡ºãƒ†ã‚¹ãƒˆ</button>
                    </div>
                    <span class="status disconnected" id="automationStatus">åœæ­¢ä¸­</span>
                    <div class="info-box">
                        <strong>ğŸ® ä½¿ã„æ–¹:</strong><br>
                        1. ã‚²ãƒ¼ãƒ ç”»é¢ã‚’å…±æœ‰<br>
                        2. æ°´è‰²ã‚¨ãƒªã‚¢ã®ä½ç½®ã‚’è¨­å®š<br>
                        3. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã‚’é¸æŠ<br>
                        4. ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è‡ªå‹•æ¤œå‡ºé–‹å§‹ï¼
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="section">
            <h2>ğŸ“‹ æ¤œå‡ºãƒ­ã‚°</h2>
            <button onclick="clearLog()" style="float: right; padding: 6px 12px; font-size: 0.85em;">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <div id="logArea"></div>
        </div>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let gamepadIndex = null;
        let selectedButton = null;
        let mediaStream = null;
        let videoElement = document.getElementById('capturedVideo');
        let canvas = document.getElementById('analysisCanvas');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let automationEnabled = false;
        let lastButtonState = false;
        let detectionCount = 0;
        let missCount = 0;
        let isDetecting = false;
        let animationFrameId = null;
        let colorPickMode = false;

        // ===== ãƒ­ã‚°å‡ºåŠ› =====
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            
            if (logArea.children.length > 100) {
                logArea.removeChild(logArea.firstChild);
            }
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ===== Gamepad API =====
        window.addEventListener('gamepadconnected', (e) => {
            gamepadIndex = e.gamepad.index;
            log(`âœ“ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ¥ç¶š: ${e.gamepad.id}`, 'success');
            document.getElementById('gamepadStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
            document.getElementById('gamepadStatus').className = 'status connected';
            updateGamepadDisplay();
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            log(`âš  ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åˆ‡æ–­`, 'warning');
            gamepadIndex = null;
            selectedButton = null;
            document.getElementById('gamepadStatus').textContent = 'æœªæ¥ç¶š';
            document.getElementById('gamepadStatus').className = 'status disconnected';
            document.getElementById('gamepadInfo').innerHTML = '';
        });

        function updateGamepadDisplay() {
            const gamepads = navigator.getGamepads();
            const gamepadInfoDiv = document.getElementById('gamepadInfo');
            
            if (!gamepads || gamepadIndex === null) return;
            
            const gamepad = gamepads[gamepadIndex];
            if (!gamepad) return;

            if (gamepadInfoDiv.children.length === 0) {
                const card = document.createElement('div');
                card.className = 'gamepad-card';
                card.innerHTML = `
                    <strong>ğŸ® ${gamepad.id.substring(0, 30)}...</strong>
                    <div class="button-grid" id="buttonGrid"></div>
                `;
                gamepadInfoDiv.appendChild(card);
            }

            const buttonGrid = document.getElementById('buttonGrid');
            buttonGrid.innerHTML = '';

            gamepad.buttons.forEach((button, index) => {
                const btnElement = document.createElement('div');
                btnElement.className = 'gamepad-button';
                btnElement.textContent = `BTN ${index}`;
                
                if (button.pressed) {
                    btnElement.classList.add('pressed');
                }
                
                if (selectedButton === index) {
                    btnElement.classList.add('selected');
                }
                
                btnElement.onclick = () => selectButton(index);
                buttonGrid.appendChild(btnElement);
            });

            // ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§è‡ªå‹•æ¤œå‡ºãƒˆã‚°ãƒ«
            if (selectedButton !== null) {
                const currentButtonState = gamepad.buttons[selectedButton].pressed;
                if (currentButtonState && !lastButtonState) {
                    toggleAutomation();
                }
                lastButtonState = currentButtonState;
            }

            requestAnimationFrame(updateGamepadDisplay);
        }

        function selectButton(index) {
            selectedButton = index;
            log(`âœ“ ãƒœã‚¿ãƒ³ ${index} ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«è¨­å®š`, 'success');
        }

        // ===== ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ =====
        async function startCapture() {
            try {
                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        mediaSource: 'screen',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                videoElement.srcObject = mediaStream;
                videoElement.onloadedmetadata = () => {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    log(`âœ“ ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹: ${canvas.width}x${canvas.height}`, 'success');
                };

                document.getElementById('captureStatus').textContent = 'å…±æœ‰ä¸­';
                document.getElementById('captureStatus').className = 'status connected';
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('stopCaptureBtn').disabled = false;
                document.getElementById('pickColorBtn').disabled = false;

                mediaStream.getVideoTracks()[0].onended = () => stopCapture();

            } catch (err) {
                log(`âœ— ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        function stopCapture() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                videoElement.srcObject = null;
                log('âš  ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£åœæ­¢', 'warning');
            }
            if (automationEnabled) toggleAutomation();
            document.getElementById('captureStatus').textContent = 'æœªå…±æœ‰';
            document.getElementById('captureStatus').className = 'status disconnected';
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('stopCaptureBtn').disabled = true;
            document.getElementById('pickColorBtn').disabled = true;
        }

        // ===== è‰²æŠ½å‡ºãƒ¢ãƒ¼ãƒ‰ =====
        function pickColor() {
            colorPickMode = !colorPickMode;
            const btn = document.getElementById('pickColorBtn');
            if (colorPickMode) {
                btn.textContent = 'âœ“ ã‚¯ãƒªãƒƒã‚¯ã—ã¦è‰²ã‚’é¸æŠ';
                btn.classList.add('success');
                canvas.style.cursor = 'crosshair';
                canvas.onclick = extractColor;
            } else {
                btn.textContent = 'ğŸ¨ ç”»é¢ã‹ã‚‰è‰²æŠ½å‡º';
                btn.classList.remove('success');
                canvas.style.cursor = 'default';
                canvas.onclick = null;
            }
        }

        function extractColor(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(x, y, 1, 1);
            const [r, g, b] = imageData.data;
            
            const hex = '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
            document.getElementById('targetColor').value = hex;
            document.getElementById('colorPreview').style.background = hex;
            
            log(`ğŸ¨ è‰²ã‚’æŠ½å‡º: ${hex} (${r}, ${g}, ${b})`, 'success');
            pickColor(); // ãƒ¢ãƒ¼ãƒ‰è§£é™¤
        }

        // ===== è‰²æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  =====
        function detectCyanArea() {
            if (!videoElement.srcObject || videoElement.readyState < 2) return null;

            // Canvas ã«æç”»
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            // è¨­å®šå–å¾—
            const detectX = parseInt(document.getElementById('detectX').value) / 100 * canvas.width;
            const yStart = parseInt(document.getElementById('detectYStart').value) / 100 * canvas.height;
            const yEnd = parseInt(document.getElementById('detectYEnd').value) / 100 * canvas.height;
            const targetColorHex = document.getElementById('targetColor').value;
            const threshold = parseInt(document.getElementById('colorThreshold').value);
            const scanStep = parseInt(document.getElementById('scanDensity').value);

            // ç›®æ¨™è‰²ã®RGB
            const targetRGB = hexToRgb(targetColorHex);

            // Yè»¸æ–¹å‘ã«ã‚¹ã‚­ãƒ£ãƒ³
            for (let y = yStart; y < yEnd; y += scanStep) {
                const imageData = ctx.getImageData(detectX, y, 1, 1);
                const [r, g, b] = imageData.data;

                // è‰²å·®è¨ˆç®—
                const colorDiff = Math.abs(r - targetRGB.r) + 
                                 Math.abs(g - targetRGB.g) + 
                                 Math.abs(b - targetRGB.b);

                if (colorDiff <= threshold) {
                    return { x: detectX, y: y, detected: true };
                }
            }

            return { x: detectX, y: (yStart + yEnd) / 2, detected: false };
        }

        // ===== HEX â†’ RGB å¤‰æ› =====
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 191, b: 255 };
        }

        // ===== æ¤œå‡ºãƒ†ã‚¹ãƒˆ =====
        function testDetection() {
            const result = detectCyanArea();
            if (result) {
                if (result.detected) {
                    log(`âœ“ æ°´è‰²æ¤œå‡ºæˆåŠŸï¼ä½ç½®: (${Math.round(result.x)}, ${Math.round(result.y)})`, 'success');
                    showDetectionMarker(result.x, result.y, true);
                } else {
                    log(`âš  æ°´è‰²æœªæ¤œå‡º`, 'warning');
                    showDetectionMarker(result.x, result.y, false);
                }
            } else {
                log('âœ— ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }
        }

        // ===== æ¤œå‡ºãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º =====
        function showDetectionMarker(x, y, detected) {
            const marker = document.createElement('div');
            marker.className = 'detection-marker';
            if (detected) marker.classList.add('detected');
            
            const rect = canvas.getBoundingClientRect();
            marker.style.left = (x / canvas.width * 100) + '%';
            marker.style.top = (y / canvas.height * 100) + '%';
            
            document.getElementById('videoContainer').appendChild(marker);
            setTimeout(() => marker.remove(), 1000);
        }

        // ===== è‡ªå‹•æ¤œå‡ºãƒ«ãƒ¼ãƒ—ï¼ˆé€Ÿåº¦ç„¡é–¢ä¿‚ï¼‰ =====
        let lastDetectionState = false; // å‰å›ã®æ¤œå‡ºçŠ¶æ…‹
        let detectionCooldown = false; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã‹
        
        function autoDetectionLoop() {
            if (!automationEnabled) return;

            const result = detectCyanArea();
            const currentState = result && result.detected;
            
            // æœªæ¤œå‡ºâ†’æ¤œå‡ºã«å¤‰åŒ–ã—ãŸç¬é–“ã®ã¿åå¿œï¼ˆç«‹ã¡ä¸ŠãŒã‚Šã‚¨ãƒƒã‚¸æ¤œå‡ºï¼‰
            if (currentState && !lastDetectionState && !detectionCooldown) {
                detectionCount++;
                log(`âœ“ [${detectionCount}] æ°´è‰²ã‚¨ãƒªã‚¢çªå…¥ï¼è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œ`, 'success');
                showDetectionMarker(result.x, result.y, true);
                updateStats();
                
                // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®šï¼ˆé€£ç¶šæ¤œå‡ºé˜²æ­¢ï¼‰
                detectionCooldown = true;
                const cooldownTime = parseInt(document.getElementById('reactionSpeed').value);
                setTimeout(() => {
                    detectionCooldown = false;
                }, cooldownTime);
            }
            
            lastDetectionState = currentState;

            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†å®Ÿè¡Œï¼ˆ60fps = ç´„16msé–“éš”ï¼‰
            animationFrameId = requestAnimationFrame(autoDetectionLoop);
        }

        // ===== çµ±è¨ˆæ›´æ–° =====
        function updateStats() {
            document.getElementById('statClicks').textContent = detectionCount;
            document.getElementById('statMiss').textContent = missCount;
            const rate = detectionCount + missCount > 0 
                ? Math.round(detectionCount / (detectionCount + missCount) * 100) 
                : 0;
            document.getElementById('statRate').textContent = rate + '%';
        }

        // ===== è‡ªå‹•æ¤œå‡ºON/OFF =====
        function toggleAutomation() {
            if (!mediaStream) {
                log('âš  å…ˆã«ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            automationEnabled = !automationEnabled;
            const btn = document.getElementById('automationBtn');
            const status = document.getElementById('automationStatus');
            
            if (automationEnabled) {
                btn.textContent = 'ğŸ›‘ è‡ªå‹•æ¤œå‡º: ON';
                btn.classList.add('danger');
                btn.classList.remove('success');
                status.textContent = 'æ¤œå‡ºä¸­';
                status.className = 'status active';
                log(`ğŸš€ è‡ªå‹•æ¤œå‡ºã‚’é–‹å§‹ã—ã¾ã—ãŸ`, 'success');
                autoDetectionLoop();
            } else {
                btn.textContent = 'ğŸš€ è‡ªå‹•æ¤œå‡º: OFF';
                btn.classList.remove('danger');
                btn.classList.add('success');
                status.textContent = 'åœæ­¢ä¸­';
                status.className = 'status disconnected';
                log('â¹ï¸ è‡ªå‹•æ¤œå‡ºã‚’åœæ­¢ã—ã¾ã—ãŸ', 'warning');
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            }
        }

        // ===== UIæ›´æ–° =====
        document.getElementById('targetColor').addEventListener('input', (e) => {
            document.getElementById('colorPreview').style.background = e.target.value;
        });

        document.getElementById('colorThreshold').addEventListener('input', (e) => {
            document.getElementById('thresholdValue').textContent = e.target.value;
        });

        // ===== åˆæœŸåŒ– =====
        log('ğŸ¯ ãƒ©ãƒãƒ­ãƒƒãƒˆè‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«èµ·å‹•', 'success');
        log('ğŸ“± ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’æ¥ç¶šã—ã¦ãã ã•ã„', 'info');
        
        setInterval(() => {
            if (gamepadIndex !== null) {
                updateGamepadDisplay();
            }
        }, 50);
    </script>
</body>
</html>
