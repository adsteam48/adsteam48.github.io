<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ è‡ªå‹•æ“ä½œãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .status.active {
            background: #fff3cd;
            color: #856404;
        }
        #gamepadInfo {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .gamepad-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .gamepad-button {
            padding: 8px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .gamepad-button:hover {
            background: #dee2e6;
        }
        .gamepad-button.pressed {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .gamepad-button.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        #videoContainer {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
        }
        #capturedVideo {
            width: 100%;
            height: auto;
            display: block;
        }
        #analysisCanvas {
            display: none;
        }
        .detection-zones {
            margin-top: 15px;
        }
        .zone-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .zone-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .zone-controls input {
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9em;
        }
        #logArea {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.info { color: #0ff; }
        .log-entry.success { color: #0f0; }
        .log-entry.warning { color: #ff0; }
        .log-entry.error { color: #f00; }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ è‡ªå‹•æ“ä½œãƒ„ãƒ¼ãƒ«</h1>
        <p class="subtitle">Gamepad API + Screen Capture + ç”»åƒè§£æã«ã‚ˆã‚‹è‡ªå‹•æ“ä½œã‚·ã‚¹ãƒ†ãƒ </p>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ¥ç¶šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“± ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ¥ç¶š</h2>
            <p>USBã¾ãŸã¯Bluetoothã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’æ¥ç¶šã—ã¦ãã ã•ã„</p>
            <span class="status disconnected" id="gamepadStatus">æœªæ¥ç¶š</span>
            <div id="gamepadInfo"></div>
        </div>

        <!-- ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ–¥ï¸ ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£</h2>
            <p>ã‚²ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã‚¿ãƒ–ã‚’å…±æœ‰ã—ã¦ãã ã•ã„</p>
            <div class="action-buttons">
                <button onclick="startCapture()" id="captureBtn">ç”»é¢å…±æœ‰é–‹å§‹</button>
                <button onclick="stopCapture()" id="stopCaptureBtn" disabled>å…±æœ‰åœæ­¢</button>
            </div>
            <span class="status disconnected" id="captureStatus">æœªå…±æœ‰</span>
            <div id="videoContainer">
                <video id="capturedVideo" autoplay playsinline></video>
            </div>
            <canvas id="analysisCanvas"></canvas>
        </div>

        <!-- æ¤œå‡ºã‚¾ãƒ¼ãƒ³è¨­å®š -->
        <div class="section">
            <h2>ğŸ¯ è‡ªå‹•æ“ä½œè¨­å®š</h2>
            <p>ç”»é¢ä¸Šã®ç‰¹å®šã®è‰²ã‚’æ¤œå‡ºã—ã¦è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™</p>
            <div class="detection-zones">
                <div class="zone-item">
                    <span><strong>æ¤œå‡ºã‚¾ãƒ¼ãƒ³ 1</strong></span>
                    <button onclick="addDetectionZone()">+ ã‚¾ãƒ¼ãƒ³è¿½åŠ </button>
                </div>
                <div class="zone-controls">
                    <input type="number" id="zone1X" placeholder="Xåº§æ¨™ (%)" value="50" min="0" max="100">
                    <input type="number" id="zone1Y" placeholder="Yåº§æ¨™ (%)" value="50" min="0" max="100">
                    <input type="color" id="zone1Color" value="#ff0000" title="æ¤œå‡ºã™ã‚‹è‰²">
                    <input type="number" id="zone1Threshold" placeholder="è‰²ã®è¨±å®¹èª¤å·®" value="30" min="0" max="255">
                </div>
            </div>
        </div>

        <!-- è‡ªå‹•æ“ä½œåˆ¶å¾¡ -->
        <div class="section">
            <h2>âš¡ è‡ªå‹•æ“ä½œåˆ¶å¾¡</h2>
            <p>é¸æŠã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨è‡ªå‹•æ“ä½œãŒå®Ÿè¡Œã•ã‚Œã¾ã™</p>
            <div class="action-buttons">
                <button onclick="toggleAutomation()" id="automationBtn">è‡ªå‹•æ“ä½œ: OFF</button>
                <button onclick="testClick()" id="testClickBtn">ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œ</button>
            </div>
            <span class="status disconnected" id="automationStatus">åœæ­¢ä¸­</span>
        </div>

        <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
        <div class="section">
            <h2>ğŸ“‹ æ“ä½œãƒ­ã‚°</h2>
            <div id="logArea"></div>
        </div>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let gamepadIndex = null; // æ¥ç¶šã•ã‚ŒãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        let selectedButton = null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸãƒœã‚¿ãƒ³ç•ªå·
        let mediaStream = null; // ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ 
        let videoElement = document.getElementById('capturedVideo');
        let canvas = document.getElementById('analysisCanvas');
        let ctx = canvas.getContext('2d');
        let automationEnabled = false; // è‡ªå‹•æ“ä½œã®æœ‰åŠ¹/ç„¡åŠ¹
        let animationFrameId = null; // requestAnimationFrameã®ID

        // ===== ãƒ­ã‚°å‡ºåŠ›é–¢æ•° =====
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            
            // ãƒ­ã‚°ãŒ100è¡Œã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
            if (logArea.children.length > 100) {
                logArea.removeChild(logArea.firstChild);
            }
        }

        // ===== Gamepad API: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ¤œå‡º =====
        window.addEventListener('gamepadconnected', (e) => {
            gamepadIndex = e.gamepad.index;
            log(`ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ¥ç¶š: ${e.gamepad.id}`, 'success');
            document.getElementById('gamepadStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
            document.getElementById('gamepadStatus').className = 'status connected';
            updateGamepadDisplay();
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            log(`ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åˆ‡æ–­: ${e.gamepad.id}`, 'warning');
            gamepadIndex = null;
            selectedButton = null;
            document.getElementById('gamepadStatus').textContent = 'æœªæ¥ç¶š';
            document.getElementById('gamepadStatus').className = 'status disconnected';
            document.getElementById('gamepadInfo').innerHTML = '';
        });

        // ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼çŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–° =====
        function updateGamepadDisplay() {
            const gamepads = navigator.getGamepads();
            const gamepadInfoDiv = document.getElementById('gamepadInfo');
            
            if (!gamepads || gamepadIndex === null) return;
            
            const gamepad = gamepads[gamepadIndex];
            if (!gamepad) return;

            // åˆå›ã®ã¿ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            if (gamepadInfoDiv.children.length === 0) {
                const card = document.createElement('div');
                card.className = 'gamepad-card';
                card.innerHTML = `
                    <strong>${gamepad.id}</strong>
                    <div class="button-grid" id="buttonGrid"></div>
                `;
                gamepadInfoDiv.appendChild(card);
            }

            const buttonGrid = document.getElementById('buttonGrid');
            buttonGrid.innerHTML = '';

            // å…¨ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            gamepad.buttons.forEach((button, index) => {
                const btnElement = document.createElement('div');
                btnElement.className = 'gamepad-button';
                btnElement.textContent = `BTN ${index}`;
                
                // æŠ¼ã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (button.pressed) {
                    btnElement.classList.add('pressed');
                }
                
                // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒœã‚¿ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (selectedButton === index) {
                    btnElement.classList.add('selected');
                }
                
                // ã‚¯ãƒªãƒƒã‚¯ã§ãƒœã‚¿ãƒ³é¸æŠ
                btnElement.onclick = () => selectButton(index);
                
                buttonGrid.appendChild(btnElement);
            });

            // é¸æŠãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰è‡ªå‹•æ“ä½œå®Ÿè¡Œ
            if (automationEnabled && selectedButton !== null && gamepad.buttons[selectedButton].pressed) {
                executeAutomation();
            }

            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†åº¦æ›´æ–°
            requestAnimationFrame(updateGamepadDisplay);
        }

        // ===== ãƒœã‚¿ãƒ³é¸æŠ =====
        function selectButton(index) {
            selectedButton = index;
            log(`ãƒœã‚¿ãƒ³ ${index} ã‚’è‡ªå‹•æ“ä½œãƒˆãƒªã‚¬ãƒ¼ã«è¨­å®š`, 'info');
        }

        // ===== ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹ =====
        async function startCapture() {
            try {
                // Screen Capture APIã§ç”»é¢ã‚’å–å¾—
                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' },
                    audio: false
                });

                videoElement.srcObject = mediaStream;
                videoElement.onloadedmetadata = () => {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    log(`ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹: ${canvas.width}x${canvas.height}`, 'success');
                };

                document.getElementById('captureStatus').textContent = 'å…±æœ‰ä¸­';
                document.getElementById('captureStatus').className = 'status connected';
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('stopCaptureBtn').disabled = false;

                // åœæ­¢æ™‚ã®å‡¦ç†
                mediaStream.getVideoTracks()[0].onended = () => {
                    stopCapture();
                };

            } catch (err) {
                log(`ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
            }
        }

        // ===== ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£åœæ­¢ =====
        function stopCapture() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                videoElement.srcObject = null;
                log('ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£åœæ­¢', 'warning');
            }
            document.getElementById('captureStatus').textContent = 'æœªå…±æœ‰';
            document.getElementById('captureStatus').className = 'status disconnected';
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('stopCaptureBtn').disabled = true;
        }

        // ===== ç”»åƒè§£æ: ç‰¹å®šè‰²ã®æ¤œå‡º =====
        function analyzeScreen() {
            if (!videoElement.srcObject) return null;

            // videoã‚’canvasã«æç”»
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // æ¤œå‡ºã‚¾ãƒ¼ãƒ³ã®è¨­å®šã‚’å–å¾—
            const x = parseInt(document.getElementById('zone1X').value) / 100 * canvas.width;
            const y = parseInt(document.getElementById('zone1Y').value) / 100 * canvas.height;
            const targetColor = hexToRgb(document.getElementById('zone1Color').value);
            const threshold = parseInt(document.getElementById('zone1Threshold').value);

            // æŒ‡å®šåº§æ¨™ã®è‰²ã‚’å–å¾—
            const imageData = ctx.getImageData(x, y, 1, 1);
            const pixel = imageData.data;

            // è‰²ã®å·®ã‚’è¨ˆç®—
            const diff = Math.abs(pixel[0] - targetColor.r) +
                        Math.abs(pixel[1] - targetColor.g) +
                        Math.abs(pixel[2] - targetColor.b);

            // é–¾å€¤ä»¥ä¸‹ãªã‚‰ä¸€è‡´ã¨åˆ¤å®š
            if (diff <= threshold) {
                return { x, y, matched: true };
            }

            return { x, y, matched: false };
        }

        // ===== HEXè‰²ã‚’RGBã«å¤‰æ› =====
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // ===== è‡ªå‹•æ“ä½œå®Ÿè¡Œ =====
        function executeAutomation() {
            const result = analyzeScreen();
            
            if (result && result.matched) {
                // å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’è¨ˆç®—
                // æ³¨æ„: ã“ã®ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸç”»é¢ã‚’è§£æã™ã‚‹ã ã‘ã§ã€
                // å®Ÿéš›ã®ã‚¯ãƒªãƒƒã‚¯ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§è¡Œã†ã‹ã€
                // Chromeæ‹¡å¼µæ©Ÿèƒ½ãªã©ã‚’åˆ¥é€”åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                
                log(`âœ“ è‰²æ¤œå‡ºæˆåŠŸ (${Math.round(result.x)}, ${Math.round(result.y)}) - è‡ªå‹•æ“ä½œå®Ÿè¡Œ`, 'success');
                
                // ã“ã“ã«å®Ÿéš›ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè£…
                // ä¾‹: sendClickToGame(result.x, result.y);
            }
        }

        // ===== ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯ =====
        function testClick() {
            const result = analyzeScreen();
            if (result) {
                log(`ãƒ†ã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯: åº§æ¨™(${Math.round(result.x)}, ${Math.round(result.y)}) - è‰²${result.matched ? 'ä¸€è‡´' : 'ä¸ä¸€è‡´'}`, 
                    result.matched ? 'success' : 'warning');
            } else {
                log('ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }
        }

        // ===== è‡ªå‹•æ“ä½œON/OFFåˆ‡ã‚Šæ›¿ãˆ =====
        function toggleAutomation() {
            automationEnabled = !automationEnabled;
            const btn = document.getElementById('automationBtn');
            const status = document.getElementById('automationStatus');
            
            if (automationEnabled) {
                btn.textContent = 'è‡ªå‹•æ“ä½œ: ON';
                status.textContent = 'å®Ÿè¡Œä¸­';
                status.className = 'status active';
                log('è‡ªå‹•æ“ä½œã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ', 'success');
            } else {
                btn.textContent = 'è‡ªå‹•æ“ä½œ: OFF';
                status.textContent = 'åœæ­¢ä¸­';
                status.className = 'status disconnected';
                log('è‡ªå‹•æ“ä½œã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', 'warning');
            }
        }

        // ===== æ¤œå‡ºã‚¾ãƒ¼ãƒ³è¿½åŠ  =====
        function addDetectionZone() {
            log('è¤‡æ•°ã‚¾ãƒ¼ãƒ³æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™', 'info');
        }

        // ===== åˆæœŸåŒ– =====
        log('ãƒ–ãƒ©ã‚¦ã‚¶ã‚²ãƒ¼ãƒ è‡ªå‹•æ“ä½œãƒ„ãƒ¼ãƒ«èµ·å‹•', 'info');
        log('ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’æ¥ç¶šã—ã¦ãã ã•ã„', 'info');
        
        // Gamepad APIã®ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        setInterval(() => {
            if (gamepadIndex !== null) {
                updateGamepadDisplay();
            }
        }, 100);
    </script>
</body>
</html>
