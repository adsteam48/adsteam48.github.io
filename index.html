<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Webゲーム自動操作（画面共有対応）</title>
<style>
body { font-family: sans-serif; padding: 20px; }
h2 { margin-bottom: 10px; }
#buttons { margin-top: 20px; }
.button {
  display: inline-block;
  margin: 5px;
  padding: 10px 20px;
  background: #ccc;
  cursor: pointer;
  border-radius: 5px;
  user-select: none;
  transition: background 0.2s;
}
.button:hover { background: #bbb; }
.selected { background: #4CAF50; color: white; }
#status { margin-top: 15px; font-weight: bold; }
#gameArea { margin-top: 30px; border: 1px solid #aaa; padding: 20px; display: inline-block; }
video { max-width: 100%; border: 1px solid #000; }
</style>
</head>
<body>

<h2>Webゲーム自動操作（画面共有対応）</h2>
<p>USB/Bluetoothコントローラーを接続し、画面共有でタイミング判定を行います。</p>

<div id="buttons"></div>
<p id="status">接続待機中...</p>

<h3>画面共有プレビュー</h3>
<video id="screen" autoplay></video>
<canvas id="canvas" width="640" height="480" style="display:none"></canvas>

<script>
const buttonsContainer = document.getElementById("buttons");
const status = document.getElementById("status");
const video = document.getElementById("screen");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let selectedButton = null;

// コントローラー接続
window.addEventListener("gamepadconnected", e => {
    const gp = navigator.getGamepads()[e.gamepad.index];
    status.textContent = `接続: ${gp.id}`;
    renderButtons(gp.buttons.length);
});

// コントローラー切断
window.addEventListener("gamepaddisconnected", e => {
    status.textContent = "コントローラーが切断されました";
    buttonsContainer.innerHTML = "";
});

// ボタン表示
function renderButtons(count) {
    buttonsContainer.innerHTML = "";
    for (let i = 0; i < count; i++) {
        const btn = document.createElement("div");
        btn.textContent = `Button ${i}`;
        btn.className = "button";
        btn.dataset.index = i;
        btn.addEventListener("click", () => {
            if (selectedButton) selectedButton.classList.remove("selected");
            btn.classList.add("selected");
            selectedButton = btn;
            status.textContent = `完了: ボタン ${i} が選択されました`;
        });
        buttonsContainer.appendChild(btn);
    }
}

// ページロード時に接続済みコントローラーがあれば描画
window.addEventListener("load", () => {
    const gps = navigator.getGamepads();
    for (let gp of gps) if (gp) renderButtons(gp.buttons.length);

    // 画面共有開始
    navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
        video.srcObject = stream;
        requestAnimationFrame(processFrame);
    }).catch(err => {
        status.textContent = "画面共有が許可されませんでした";
        console.error(err);
    });
});

// 画面解析＋自動クリック
function processFrame() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // 赤色ピクセルを判定（例）
    let redCount = 0;
    for (let i = 0; i < frame.data.length; i += 4) {
        if (frame.data[i] > 200 && frame.data[i+1] < 50 && frame.data[i+2] < 50) redCount++;
    }

    if (redCount > 1000) {
        status.textContent = "画面判定: 赤色検出 → 自動クリック可能";
        // ここに自動クリック処理（Canvas座標やDOMボタン）を追加可能
        // 例: document.querySelector("#gameBtn")?.click();
    }

    requestAnimationFrame(processFrame);
}

// 自動操作ループ（選択ボタン押下で任意アクション）
function pollGamepad() {
    const gps = navigator.getGamepads();
    for (let gp of gps) {
        if (!gp) continue;
        if (selectedButton) {
            const index = parseInt(selectedButton.dataset.index);
            if (gp.buttons[index].pressed) {
                status.textContent = `ボタン ${index} 押下 → 自動操作発火`;
                // Canvas上のクリックやDOMイベントをここで発火
            }
        }
    }
    requestAnimationFrame(pollGamepad);
}

pollGamepad();
</script>

</body>
</html>
